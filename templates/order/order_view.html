{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load humanize %}
{% load mathfilters %}
<!--Form billing information-->
<section class="position-relative bg-white" id="order-view-section">
	<div class="container pb-7 pb-lg-12 pt-7 position-relative">
		<div class="row">
			<div class="col-12 mx-auto">
				<div class="table-responsive">
					<h4 class="mb-4 pt-5">Order list</h4>
					<table class="table table-striped align-middle">
						<thead>
							<tr>
								<th style="width:15%"></th>
								<th class="small text-muted">
									<div style="min-width:280px">Product</div>
								</th>
								<th class="small text-muted" style="width:15%">Price</th>
								<th class="small text-muted" style="width:20%">Quantity</th>
								<th class="small text-muted" style="width:15%">Subtotal</th>
							</tr>
						</thead>
						<tbody>
							{% if not order_items %}
							<tr>
								<td class="border-bottom-0 text-center p-5" colspan="6">상품이 없습니다.</td>
							</tr>
							{% endif%}

							{% for order_item in order_items %}
							
							<tr>
								<td>
									<img src="{% static 'img/shop/backpack2.jpg' %}" class="width-7x rounded-3">
								</td>
								<td>
									<span class="text-dark h5">
										{{order_item.product_name}}
									</span>
									{% if order_item.variant_value is not None %}
									<span class="text-uppercase d-block">
										{{order_item.variant}}: {{order_item.variant_value}}
									</span>
									
									<span class="text-uppercase d-block">+₱{{order_item.variant_price}}</span>
									{% endif %}
								</td>
								<td>
									{% if order_item.variant is not None %}
									₱{{order_item.product_price|add:order_item.variant_price|intcomma}}
									{% else %}
									₱{{order_item.product_price|intcomma}}
									{% endif %}
								</td>
								<td>
									<span class="text-uppercase d-block">{{order_item.ordered_quantity}}</span>
								</td>
								<td>
									{% if order_item.variant is not None %}
									₱{{order_item.product_price|add:order_item.variant_price|mul:order_item.ordered_quantity|intcomma}}
									{% else %}
									₱{{order_item.product_price|mul:order_item.ordered_quantity|intcomma}}
									{% endif %}
								</td>
							</tr>

							{% endfor %}
							
						</tbody>
					</table>


					<!--Checkout product info table-->
					<table class="table mb-5 table-bordered od-list-table">
						<tr class="bg-light">
							<th class="pd text-center">상품금액</th>
							<td class="pd fw-bold fs-5 text-dark total-price">₱{{total_price|intcomma}}</td>
						</tr>
						<tr>
							<th class="pd text-center">포인트사용</th>
							<td class="pd text-center fw-bold fs-5 text-dark">
								<div class="point-input text-start">
									<input type="text" name="points" step="100" min="0" value="0" class="use-point">
									<button class="btn btn-primary point-btn">전액사용</button>									
								</div>	
							</td>
						</tr>
						<tr class="bg-light">
							<th class="pd text-center">결제예정금액</th>
							<td class="pd fw-bold fs-5 text-dark">
								<span class="payment">₱{{total_price|intcomma}}</span>
							</td>
						</tr>
					</table>
				</div>
				<div class="payment-area col">
					<h4 class="mb-4">Method of payment</h4>
					<div class="mb-4 form-check">
						<input type="checkbox" class="" id="conditions_before_order" name="">
						<label class="form-check-label" for="conditions_before_order"> 
							I accept the <a href="#" class="text-dark link-decoration">Terms</a> and
							<a href="#" class="text-dark link-decoration">conditions</a> and the
							<a href="#" class="text-dark link-decoration">data protection guidelines.</a>
						</label>
					</div>
					<div class="d-grid">
						<button type="button" class="btn btn-lg hover-lift btn-hover-text btn-primary">
							<span class="btn-hover-label label-default">Place your order</span>
							<span class="btn-hover-label label-hover">Place your order</span>
						</button>
					</div>
				</div>	
			</div>		
		</div>
	</div>
</section>

<script>
let pointForm = document.querySelector(".use-point");
let totalPrice = document.querySelector(".total-price");
let pointBtn = document.querySelector(".point-btn");
let payment = document.querySelector(".payment");
let usingPoint = document.querySelector(".using-point");


const regex = /[^0-9]/g;
const result = totalPrice.innerHTML.replace(regex, "");

"propertychange change keyup paste input".split(" ").forEach(function(e){ 
	  pointForm.addEventListener(e, function(){
		let removeZero = pointForm.value.replace(/(^0+)/, "");
		pointForm.value = removeZero;
		let check = /^[0-9]+$/;

		if(!check.test(pointForm.value) && pointForm.value != ''){
			pointForm.value = 0;
			payment.innerHTML = "₱" + sumPrice;
			return false;	
		}
		
		if(Number(pointForm.value) > Number('{{request.user.point}}')){ 
			pointForm.value = '{{request.user.point}}';
			return false;
		}

		if(Number(pointForm.value) > Number('{{total_price}}')){ 
			pointForm.value = '{{total_price}}';
			return false;
		}

		let calcPrice = result - pointForm.value;
		let sumPrice= calcPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');

		payment.innerHTML = "₱" + sumPrice;				
		
	});
});

pointBtn.addEventListener("click", function(){
	pointForm.value = '{{request.user.point}}';

	let calcPrice = result - pointForm.value;
	let sumPrice= calcPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');

	payment.innerHTML = "₱" + sumPrice;			
});


async function order_submit() {
	if(is_run == true) {
		openModal('알림','잠시후에 다시시도 해주세요.');
		return false;
	}

	is_run = true;

	let form_data = new FormData();
	form_data.append('order_id', '{{request.GET.id}}')
	form_data.append('used_point', pointForm.value)

    const response = await fetch("{% url 'charge:payment' %}", {
		method: "POST",
		headers: {
			"X-CSRFToken": getCookie("csrftoken"),
		},
		body: form_data,
	})
	.then(response => response.json())
	.then(data => {
		console.log(data);
		is_run  = false;
		if (data.result == '200') {
			openModal("알림", data.result_text);
		} else {
			openModal("알림", data.result_text);
		}
	});
}


</script>
{% endblock %}