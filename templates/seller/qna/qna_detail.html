{% extends 'seller/base.html' %}
{% block content %}
{% load static %}
{% load humanize %}
{% load util_filter %}

<!-- Begin page -->

<div class="page-content">
	<div class="container-fluid">
		<div class="row">
			<div class="col-12">
				<div class="page-title-box d-flex align-items-center justify-content-between">
					<h4 class="mb-0">QnA</h4>
				</div>
			</div>
		</div>
		<!-- end page title -->

		<div class="row">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-body">
						<h5 class="mt-0 mb-4 font-size-16">{{qna_detail.product.name}}</h5>

						<div>
							{{qna_detail.question}}
						</div>
						<hr/>
						
						<form name="qnaForm">
							{% csrf_token %}
							<div class="py-3">
								<h6>Answer</h6>
								<textarea class="form-control" name="answer" placeholder="Leave a comment here" style="height: 300px">{{qna_detail.answer}}</textarea>
							</div>

							<div class="d-flex justify-content-between">
								<div>
									<a href="{% url 'qna:seller_qna_list' %}" class="btn btn-light">List</a>
								</div>
								<div>
									<a href="#!" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#qnaDeleteModal">Refusal</a>
									<a href="#!" onclick="qna_submit();" class="btn btn-success">Save</a>
								</div>
							</div>
						</form>
					</div>

				</div>
			</div><!-- end col -->
		</div><!-- end row -->
	</div>
</div>


<div class="modal fade" data-bs-backdrop="static" id="qnaDeleteModal" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered modal-md">
		<div class="modal-content">
			<div class="modal-header p-4">
				<h4 class="mb-0 text-center">Alert</h4>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>

			<div class="modal-body p-4">
				<span>Do you really refuse to answer?</span>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary ms-1" onclick="qna_delete_submit();">Ok</button>
				<button type="button" class="btn btn-outline-secondary btn-md" data-bs-dismiss="modal">Cancel</button>
			</div>

		</div>
	</div>
</div>

<script>
var is_run = false;

async function qna_submit() {
	var qnaForm = document.qnaForm;
	var answer = qnaForm.answer.value;
	
	if (isEmpty(answer)) {
			openModal('Notification','Please enter answer.');
		return false;
	}

	if(is_run == true) {
		openModal('Notification','Please try again later.');
		return false;
	}

	is_run = true;
	
	const response = await fetch("{{request.path}}", {
		method: "POST",
		headers: {
			"X-CSRFToken": getCookie("csrftoken"),
		},
		body: JSON.stringify({
			'answer': answer,
		}),
	})
	.then(response => response.json())
	.then(data => {
		is_run  = false;
		if (data.result == '200') {
			openModal("Notification", data.result_text, '#qnaDeleteModal', 'reload');
		} else {
			openModal("Notification", data.result_text, '#qnaDeleteModal');
		}
	});
}


async function qna_delete_submit() {
	if(is_run == true) {
		openModal('Notification','Please try again later.');
		return false;
	}

	is_run = true;

	let qna_id = '{{qna_detail.pk}}';

    const response = await fetch("{% url 'qna:seller_qna_delete' %}", {
		method: "POST",
		headers: {
			"X-CSRFToken": getCookie("csrftoken"),
		},
		body: JSON.stringify({
			'qna_id': qna_id,
		}),
	})
	.then(response => response.json())
	.then(data => {
		console.log(data);
		is_run  = false;
		if (data.result == '200') {
			openModal("Notification", data.result_text, '#qnaDeleteModal', 'window.location = "/seller/qna"');
		} else {
			openModal("Notification", data.result_text, '#qnaDeleteModal');
		}
	});
}

</script>

{% endblock %}
