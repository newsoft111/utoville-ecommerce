{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load humanize %}
{% load product_filter %}


<!-- Section -->
<!-- SHOP DETAILS
================================================== -->
<section>
	<div class="container">

		<!-- product section -->
		<div class="row mb-6 mb-md-7 mb-lg-9">
			<div class="col-lg-5 text-center text-lg-start mb-1-9 mb-lg-0">

				<!-- product left start -->
				<div class="xzoom-container">
					<img class="xzoom5 mb-1-9" id="xzoom-magnific" src="img/shop/preview/01_product.jpg" xoriginal="img/shop/original/01_product.jpg" />
					<div class="xzoom-thumbs m-0">
						<a href="img/shop/original/01_product.jpg"><img class="xzoom-gallery5" width="80" src="img/shop/thumbs/01_product.jpg" xpreview="img/shop/preview/01_product.jpg" title="The description goes here"></a>
						<a href="img/shop/original/02_product.jpg"><img class="xzoom-gallery5" width="80" src="img/shop/preview/02_product.jpg" title="The description goes here"></a>
						<a href="img/shop/original/03_product.jpg"><img class="xzoom-gallery5" width="80" src="img/shop/preview/03_product.jpg" title="The description goes here"></a>
						<a href="img/shop/original/04_product.jpg"><img class="xzoom-gallery5" width="80" src="img/shop/preview/04_product.jpg" title="The description goes here"></a>
					</div>
				</div>
				<!-- product left end -->

			</div>
			<div class="col-lg-7 ps-lg-2-7">
				<div class="product-detail">
					<h3 class="mb-2">서비스 제목</h3>
					<div class="bg-primary separator-line-horrizontal-full mb-4"></div>
					<p class="rating-text display-30"><span>지역:</span> <span>더 좋은 아이디어 있으면 그걸로 대체</span></p>
					<p >서비스의 간략한 설명 1~3줄</p>
					<div class="mb-3">
						<span class="me-3 display-26 font-weight-600 offer-price">$499.00</span>
						<span class="display-26 font-weight-700 text-primary">$299.00</span>
					</div>

					<div class="row">
						{% if product_detail.productvariant_set.all %}
						<select id="optionFirst" class="form-select form-select-lg mb-3" onchange="set_variant_value(this)">
							<option selected>옵션1</option>
							{% for variant in product_detail.productvariant_set.all %}
							<option value="{{variant}}" data-value="{{variant}}">{{variant}}</option>
							{% endfor %}
						</select>
						<select id="optionSecond" onchange="add_item(this)" class="form-select form-select-lg mb-3">
							<option selected>옵션2</option>
						</select>
					{% endif %}
					</div>
					<div class="row">
						<div class="pd_qty col-4 col-lg-2">
							<label>Qty 장바구니의 Qty와 통일:</label>
							<input type="text" value="1" placeholder="1" class="mb-3 form-control">
						</div>

					</div>

					<div class="row mb-3">
						<div class="buy_area col-lg-12">					
							<div class="bd-example mb-2">
								<a href="#!" class="cart_btn butn-style3"><span><i class="fas fa-shopping-cart me-1"></i> Add to Cart</span></a>
								<a href="#!" class="buy_btn butn-style3"><span><i class="fas fa-shopping-cart me-1"></i> Buy Now!</span></a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- end product section -->

		<!-- product description -->
		<div class="row mb-6 mb-lg-8">

			<div class="col-12">
				<div class="horizontaltab tab-style5">
					<ul class="resp-tabs-list hor_1 text-start">
						<li>Description</li>
						<li>Additional Info</li>
						<li>Reviews (2)</li>
					</ul>
					<div class="resp-tabs-container hor_1">
						<div>
							<p >Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto in ea voluptate velit. Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto in ea voluptate velit.</p>
							<p class="m-0">Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto in ea voluptate velit. Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto in ea voluptate velit.</p>

						</div>
						<div>
							<div class="row align-items-center">
								<div class="col-lg-6 mb-4 mb-lg-0">
									<ul class="list-style-5">
										<li><strong>Weight:</strong> 0.150 Kg</li>
										<li><strong>Dimensions:</strong> 90x60x90 Cm</li>
										<li><strong>Size:</strong> One Size Fits All</li>
										<li><strong>Color:</strong> Gray</li>
										<li><strong>Guarantee:</strong> 5 Years</li>
									</ul>
								</div>
								<div class="col-lg-6 ps-lg-1-9">
									<p >Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto in ea voluptate velit.</p>
									<p class="m-0">Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto in ea voluptate velit.</p>
								</div>
							</div>

						</div>
						<div>
							<div class="row">
								<div class="col-lg-6 mb-4 mb-lg-0">
									<form class="quform" action="quform/contact.php" method="post" enctype="multipart/form-data" onclick="">

										<div class="quform-elements">

											<div class="row">

												<form name="reviewWriteForm">
													{% csrf_token %}
													<input type="hidden" name="order_id" value="">
													<div class="modal-body p-4 text-center">			
														<h5>만족하셨나요?</h5>
														<div class="rating">
															<input type="radio" name="rating" value="5" id="review-start-5"><label for="review-start-5">☆</label>
															<input type="radio" name="rating" value="4" id="review-start-4"><label for="review-start-4">☆</label>
															<input type="radio" name="rating" value="3" id="review-start-3"><label for="review-start-3">☆</label>
															<input type="radio" name="rating" value="2" id="review-start-2"><label for="review-start-2">☆</label>
															<input type="radio" name="rating" value="1" id="review-start-1"><label for="review-start-1">☆</label>
														</div>
													</div>
													<div class="py-3">
														<h5>어떤 점이 좋았나요?</h5>
														<textarea type="text" name="review" class="form-control" rows="5"></textarea>
													</div>	
													<div class="upload_photo p-4 text-center">
														<h5>사진을 첨부해주세요.</h5>
														<div class="input-group" id="preview">
															<input type="file" accept="image/gif, image/jpeg, image/png" class="form-control" id="inputGroupFile04" multiple aria-describedby="inputGroupFileAddon04" aria-label="Upload">
														</div>
													</div>
													<div class="review_area p-4 text-center">
														<h5>리뷰를 작성해주세요.</h5>
														<textarea class="form-control" style="resize:none"></textarea>		
													</div>
													<div class="modal-footer">
														<button type="button" class="btn btn-outline-primary ms-1" onclick="review_write_submit()">완료</button>
														<button type="button" class="btn btn-primary btn-md" id="reviewModalCloseBtn" data-bs-dismiss="modal">취소</button>
													</div>
												</form>

											</div>

										</div>

									</form>
								</div>
								<div class="col-lg-6 ps-lg-4">

									<div class="mb-3">
										<p class="p-0 mb-0"><strong>Nathan Ford,</strong> Sep 15, 2018</p>
										<div class="mb-3 display-30">
											<i class="fas fa-star"></i>
											<i class="fas fa-star"></i>
											<i class="fas fa-star"></i>
											<i class="fas fa-star"></i>
											<i class="fas fa-star-half-alt"></i>
										</div>
										<p >Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the standard dummy text. Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the standard dummy text.</p>
										<div class="bg-medium-light-gray separator-line-horrizontal-full"></div>
									</div>

									<div>
										<p class="m-0"><strong>Mac Still,</strong> Aug 08, 2018</p>
										<div class="mb-3 display-30">
											<i class="fas fa-star"></i>
											<i class="fas fa-star"></i>
											<i class="fas fa-star"></i>
											<i class="fas fa-star"></i>
											<i class="fas fa-star-half-alt"></i>
										</div>
										<p class="mb-0">Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the standard dummy text. Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the standard dummy text.</p>

									</div>

								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- end product description -->

		<!-- related product -->
		<div class="row">
			<div class="col-12">
				<div class="section-heading title-style3">
					<h3 class="h4">Related Products</h3>
				</div>
			</div>

			<div class="carousel-style4 col-12">
				<div class="product-grid control-top owl-carousel owl-theme">

					<div class="border">
						<div class="product-info">
							<a href="#!">Party Dresses</a>
							<p class="price text-center m-0">
								<span class="red line-through me-2">$600</span>
								<span>$599</span>
							</p>
						</div>
						<div class="buttons">
							<a href="#!" class="bg-extra-dark-gray text-white"><i class="fas fa-heart me-2"></i>Wishlist</a>
							<a href="#!" class="bg-primary text-white"><i class="fas fa-shopping-cart me-2"></i>Add to Cart</a>
						</div>

					</div>
					<div class="border">

						<a href="#!" class="product-block"><img src="img/shop/product-11.jpg" alt="..."></a>
						<div class="product-info">
							<a href="#!">Women Bandage</a>
							<p class="price text-center m-0">
								<span class="red line-through me-2">$500</span>
								<span>$300</span>
							</p>
						</div>
						<div class="buttons">
							<a href="#!" class="bg-extra-dark-gray text-white"><i class="fas fa-heart me-2"></i>Wishlist</a>
							<a href="#!" class="bg-primary text-white"><i class="fas fa-shopping-cart me-2"></i>Add to Cart</a>
						</div>

					</div>
					<div class="border">

						<a href="#!" class="product-block">
							<div class="label-offer bg-primary">New</div><img src="img/shop/product-12.jpg" alt="...">
						</a>
						<div class="product-info">
							<a href="#!">Short Red Dress</a>
							<p class="price text-center m-0">
								<span class="red line-through me-2">$200</span>
								<span>$100</span>
							</p>
						</div>
						<div class="buttons">
							<a href="#!" class="bg-extra-dark-gray text-white"><i class="fas fa-heart me-2"></i>Wishlist</a>
							<a href="#!" class="bg-primary text-white"><i class="fas fa-shopping-cart me-2"></i>Add to Cart</a>
						</div>

					</div>
					<div class="border">

						<a href="#!" class="product-block">
							<div class="label-offer bg-red">Sale</div><img src="img/shop/product-13.jpg" alt="...">
						</a>
						<div class="product-info">
							<a href="#!">Short Flower Print</a>
							<p class="price text-center m-0">
								<span class="red line-through me-2">$1200</span>
								<span>$900</span>
							</p>
						</div>
						<div class="buttons">
							<a href="#!" class="bg-extra-dark-gray text-white"><i class="fas fa-heart me-2"></i>Wishlist</a>
							<a href="#!" class="bg-primary text-white"><i class="fas fa-shopping-cart me-2"></i>Add to Cart</a>
						</div>

					</div>
					<div class="border">

						<a href="#!" class="product-block"><img src="img/shop/product-14.jpg" alt="..."></a>
						<div class="product-info">
							<a href="#!">Black fly Design</a>
							<p class="price text-center m-0">
								<span class="red line-through me-2">$399</span>
								<span>$199</span>
							</p>
						</div>
						<div class="buttons">
							<a href="#!" class="bg-extra-dark-gray text-white"><i class="fas fa-heart me-2"></i>Wishlist</a>
							<a href="#!" class="bg-primary text-white"><i class="fas fa-shopping-cart me-2"></i>Add to Cart</a>
						</div>

					</div>
					<div class="border">

						<a href="#!" class="product-block">
							<div class="label-offer bg-primary">New</div><img src="img/shop/product-15.jpg" alt="...">
						</a>
						<div class="product-info">
							<a href="#!">Black Flower Print</a>
							<p class="price text-center m-0">
								<span class="red line-through me-2">$800</span>
								<span>$699</span>
							</p>
						</div>
						<div class="buttons">
							<a href="#!" class="bg-extra-dark-gray text-white"><i class="fas fa-heart me-2"></i>Wishlist</a>
							<a href="#!" class="bg-primary text-white"><i class="fas fa-shopping-cart me-2"></i>Add to Cart</a>
						</div>

					</div>

				</div>
			</div>

		</div>
		<!-- end related product -->

	</div>
</section>

<script>
is_run = false;

function add_cart_submit(product_id) {
	is_run = true;

	let data = document.querySelector("input[name=obj_data]").value;

	if (isEmpty(data)) {
		openModal('알림','옵션을 선택해주세요.');
		return false;
	}

    $.ajax({
        type : 'POST',
        url : "{% url 'cart:add' %}",
		headers: { "X-CSRFToken": '{{csrf_token}}' },
        data : {
			data: data,
		},
        dataType : 'json',
        success: function(data){
			if(data.result==200){
				openModal("알림", data.result_text,'', 'reload');
			}else{
				openModal("알림", data.result_text);
			}
			is_run  = false;
        },
        error: function (request, status, error){
          var msg = "ERROR : " + request.status + "<br>"
			    msg +=  + "내용 : " + request.responseText + "<br>" + error;
			    console.log(msg);
        }
    });
}

function set_variant_value(e) {
	let key = e.options[e.selectedIndex].value;
	let json_data = JSON.parse("{{variant_data|escapejs}}");
	let html='<option selected>옵션2</optimPriceon>';

	for (idx in json_data[key]) {
		value = json_data[key][idx];
		html+=`<option value="${value['value']}" data-id="${value['id']}" data-value="${value['value']}" data-price="${value['price']}">${value['value']} + ${value['price']}원</option>`;
	}

	document.getElementById("optionSecond").innerHTML = html;
}


function cal_total_value() {
	let total_price = document.getElementById("totalPrice");
	let item_list = document.querySelectorAll("span[id=itemPrice]");
	let arr = [];

	let total = 0;
	let count = 0;

	for (i=0; i<item_list.length; i++) {
		let item = item_list[i];

		total += Number(item.innerHTML.replace(/[^0-9]/g, ""));
		count += Number(item.previousSibling.value);
		
		let objData = new Object();
		objData.product_id = "{{product_detail.id}}";
		objData.variant_value_id = item.dataset.id;
		objData.qty = item.previousSibling.value;

		arr.push(objData);
	}

	document.querySelector("input[name=obj_data]").value=JSON.stringify(arr);

	document.getElementById("totalQty").innerHTML = String(count)+'개';
	total_price.innerHTML = '₱'+total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function cal_item_price(e) {
	let qty = Number(e.value);
	let ori_price = Number(e.dataset.optionPrice.replace(/[^0-9]/g, ""));

	let total_price_span = e.nextSibling;

	let total_price = qty * ori_price;
	total_price = total_price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');

	total_price_span.innerHTML = `₱${total_price}`;
	cal_total_value();
}

function add_item(e) {
	let option_first = document.getElementById("optionFirst");
	let option_first_value = option_first.options[option_first.selectedIndex].dataset.value;

	let option_second_value = e.options[e.selectedIndex].dataset.value;
	let option_second_id = e.options[e.selectedIndex].dataset.id;
	let option_second_price = '{{product_detail.price}}' + e.options[e.selectedIndex].dataset.price;
	option_second_price = option_second_price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');

	html = '<div id="productDom" class="optionTotal">';
	html += '<div class="title" id="optionTitle">';
	html += `<h6>{{product_detail.name}}</h6>`;
	html += '<a class="close" href="#" onclick="remove_item(this);">X</a>';
	html += '</div>';
	html += `<div>${option_first_value} / ${option_second_value}</div>`;
	html += '<div class="optionAdd">';
	html += `<input type="number" onfocusout="cal_item_price(this);" data-option-price='${option_second_price}' class="order_num form-control text-center" value="1" min="1">`;
	html += `<span class="price" data-id="${option_second_id}" id="itemPrice">₱${option_second_price}</span>`;
	html += '</div>';
	html += '</div>';
	
	var newstuff = document.createElement('div');
	newstuff.innerHTML = html

	let parent = document.querySelector(".selectedList");

	while (newstuff.firstChild) {
		parent.appendChild(newstuff.firstChild);
	}

	reset_variant(e, '옵션2');
	cal_total_value();
}

function remove_item(e) {
	e.parentNode.parentNode.remove();
	cal_total_value();
}

function reset_variant(e, val) {
	for( i=0,j=e.length; i<j; i++ ){
		if( e.options[i].value == val ) {
			e.options[i].selected = true;
			break;
		}
	}
}

function review_write_submit() {
      var reviewWriteForm = document.reviewWriteForm;
      var review = reviewWriteForm.review.value;
      var rating = reviewWriteForm.rating.value;
      let this_modal = "#ReviewWriteModal";
            
      if (isEmpty(rating)) {
         openPopup('알림','평점을 선택해주세요.',this_modal);
         return false;
      }

      if (isEmpty(review)) {
         openPopup('알림','리뷰를 입력해주세요.',this_modal);
         return false;
      }

      var queryString = $("form[name=reviewWriteForm]").serialize();

    $.ajax({
        type : 'POST',
        url : "",
        data : queryString,
        dataType : 'json',
        success: function(data){
          if(data.result==200){
            openPopup("알림", data.result_text,'',"reload");
          }else{
            openPopup("알림", data.result_text);
          }
          return;
        },
        error: function (request, status, error){
          var msg = "ERROR : " + request.status + "<br>"
             msg +=  + "내용 : " + request.responseText + "<br>" + error;
        }
    });
}

document.getElementById('inputGroupFile04').onchange = function() {
	let this_modal = "#gigOrderReviewModal";
	var fileTypes = ['jpg', 'jpeg', 'png', 'gif'];  //acceptable file types

	function readURL(input) {
		if (input.files && input.files[0]) {
			var extension = input.files[0].name.split('.').pop().toLowerCase(),  //file extension from input file
					isSuccess = fileTypes.indexOf(extension) > -1;  //is extension in acceptable types
			if (isSuccess) {         
				var reader = new FileReader();
				///reader.onload = function(e) {
				///   $('.gig-image-preview').removeClass("d-none");
				///   $('.gig-image-preview img').attr("src", e.target.result);
				///}
				reader.readAsDataURL(input.files[0]);
				
			} else {
				document.querySelector("[id=reviewModalCloseBtn]").click();
				openModal('알림','이미지 파일이 아닙니다.',this_modal);
				input.value='';
			}
		}
	}
	readURL(this);
}

</script>

{% endblock %}