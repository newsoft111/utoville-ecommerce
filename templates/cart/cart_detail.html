{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load humanize %}
{% load mathfilters %}
{% load product_filter %}

<!--Page header start-->
<section class="position-relative overflow-hidden">    
	<div class="container-fluid">
	  <div class="py-8 py-lg-11 bg-dark text-white position-relative">
		<!--background image-->
		<img src="assets/img/shop/banners/06.jpg" class="bg-image bg-top-center opacity-75" alt="">
	  
		<div class="row align-items-center position-relative">
		  <div class="col-lg-10 mx-auto text-center">
			<nav class="d-flex justify-content-center" aria-label="breadcrumb">
			  <ol class="breadcrumb mb-3">
				<li class="breadcrumb-item">
				  <a href="#!">Home</a>
				</li>
				<li class="breadcrumb-item active">
				  Shop
				</li>
				<li class="breadcrumb-item active">
				  Cart
				</li>
			  </ol>
			</nav>
			<h1 class="mb-0 display-3">Cart
			</h1>
		  </div>
		</div>
		<!--/.row-->
	  </div>
	</div>
  </section>

<section class="position-relative bg-white" id="cart-section">
	<div class="container pb-7 pb-lg-12 pt-7 position-relative">
		<div class="row justify-content-between">
			<div class="col-lg-10 mx-auto" id="cart-div">

				<!--Cart table start-->
				<div class="table-responsive">
					<table class="table table-striped align-middle">
						<thead>
							<tr>
								<th style="width:15%"></th>
								<th class="small text-muted">
									<div style="min-width:280px">Product</div>
								</th>
								<th class="small text-muted" style="width:15%">Price</th>
								<th class="small text-muted" style="width:20%">Quantity</th>
								<th class="small text-muted" style="width:15%">Subtotal</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							{% if not cart_items %}
							<tr>
								<td class="border-bottom-0 text-center p-5" colspan="6">상품이 없습니다.</td>
							</tr>
							{% endif%}

							{% for cart_item in cart_items %}
							<tr>
								<td>
									<div class="position-relative">
										<input type="checkbox" onchange="cal_checked_item_price();" data-product-id="{{cart_item.product.id}}" data-variant-value-id="{{cart_item.variant_value.id}}" data-qty="{{cart_item.quantity}}" class="position-absolute top-0 start-0" id="cart{{cart_item.pk}}" name="cart_item_id" value="{{cart_item.pk}}">
										<label for="cart{{cart_item.pk}}"><img src="{% static 'img/shop/backpack2.jpg' %}" class="width-7x rounded-3"></label>
									</div>
								</td>
								<td>
									<a href="#!" class="text-dark h5">
										{{cart_item.product.product_name}}
									</a>
									{% if cart_item.variant_value is not None %}
									<span class="text-uppercase d-block">
										{{cart_item.variant_value.variant}}: {{cart_item.variant_value.value}}
									</span>
									
									<span class="text-uppercase d-block">+₱{{cart_item.variant_value.price}}</span>
									{% endif %}
								</td>
								<td>
									{% if cart_item.variant_value is not None %}
									₱{{cart_item.product.price|add:cart_item.variant_value.price|intcomma}}
									{% else %}
									₱{{cart_item.product.price|intcomma}}
									{% endif %}
								</td>
								<td>
									<input type="number" min="1" onKeyDown="return false" onchange="update_cart_submit(this)" value="{{cart_item.quantity}}" data-cart-item-id="{{cart_item.id}}" value="{{cart_item.quantity}}" class="form-control border-0 shadow-none rounded-0 bg-transparent">
								</td>
								<td id="sub-total">
									{% if cart_item.variant_value is not None %}
									₱{{cart_item.product.price|add:cart_item.variant_value.price|mul:cart_item.quantity|intcomma}}
									{% else %}
									₱{{cart_item.product.price|mul:cart_item.quantity|intcomma}}
									{% endif %}
								</td>
								<td><button class="btn-close text-center" onclick="remove_cart_submit('{{cart_item.id}}');">
										<svg xmlns="http://www.w3.org/2000/svg" height="16"
											viewBox="0 0 24 24" width="20" fill="currentColor">
											<path
												d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" />
										</svg>
									</button>
								</td>
							</tr>

							{% endfor %}
							
						</tbody>
					</table>
				</div>

				<!--Update cart button-->
				<div class="text-center d-md-flex align-items-center border-bottom pb-4 mb-4">
					<div class="col-md-7 mb-4 mb-md-0 text-start">
						<button class="btn btn-brand small ms-2" onclick="checkbox_manager();"><span>전체선택</span></button>
                        <button class="btn small ms-2 mb-2 mb-sm-0" onclick="remove_checked_item();"><span>선택삭제</span></button>
					</div>
					<div class="col-md-5 text-end">
						<div class="d-flex flex-column h-100 justify-content-end">
							<strong class="text-muted d-block mb-2 fs-6">Cart total</strong>
							<h5 class="mb-0 ms-3 h2" id="total-price">₱0</h5>
						</div>
					</div>
				</div>
				<!--Cart checkout-->
				<div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-center">
					<div class="mb-3 mb-sm-0">
						<a href="{% url 'product:list' %}" class="link-hover-underline text-body"><i
								class="bx bx-left-arrow-alt fs-6 align-middle me-1"></i>Continue shopping
						</a>
					</div>
					<div>
						<a href="#!" onclick="order_submit();" class="btn btn-brand">proceed to Checkout</a>
						<input type="hidden" name="obj_data" value=''>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

<script>
is_run = false;

function remove_cart_submit(cart_item_id) {
	is_run = true;
	var modal = new bootstrap.Modal(document.getElementById("loading"), {});

	modal.show();

    $.ajax({
        type : 'POST',
        url : "{% url 'cart:remove' %}",
		headers: { "X-CSRFToken": '{{csrf_token}}' },
        data : {
			'cart_item_id[]':cart_item_id
		},
        dataType : 'json',
        success: function(data){
			if(data.result==200){
				$("#cart-div").load(" #cart-div > *");
			}else{
				openModal("알림", data.result_text);
			}
			is_run  = false;
        },
        error: function (request, status, error){
          var msg = "ERROR : " + request.status + "<br>"
			    msg +=  + "내용 : " + request.responseText + "<br>" + error;
			    console.log(msg);
        },
		complete: function () {
			setTimeout(function() {
				modal.hide();
			}, 2000);
		}
    });
}

function update_cart_submit(e) {
	is_run = true;
	var modal = new bootstrap.Modal(document.getElementById("loading"), {});
	let cart_item_id = e.dataset.cartItemId;
	let qty = e.value;

	modal.show();

    $.ajax({
        type : 'POST',
        url : "{% url 'cart:update' %}",
		headers: { "X-CSRFToken": '{{csrf_token}}' },
        data : {
			cart_item_id: cart_item_id,
			qty: qty
		},
        dataType : 'json',
        success: function(data){
			if(data.result==200){
				$("#cart-div").load(" #cart-div > *");
			}else{
				openModal("알림", data.result_text);
			}
			is_run  = false;
        },
        error: function (request, status, error){
          var msg = "ERROR : " + request.status + "<br>"
			    msg +=  + "내용 : " + request.responseText + "<br>" + error;
			    console.log(msg);
        },
		complete: function () {
			setTimeout(function() {
				modal.hide();
			}, 2000);
		}
    });
}

function checkbox_manager() {
	const allboxes = document.querySelectorAll("input[name=cart_item_id][type=checkbox]");
	// if some of the checkbox is checked
	const isSomeCheck = [...allboxes].some(item => item.checked);
	
	// if all are checked
	const isAllChecked = [...allboxes].every(item => item.checked);
	// if some are checked then on click of button check all
	if (!isSomeCheck) {
		allboxes.forEach(item => item.checked = true);
	} else if (isAllChecked && isSomeCheck) {
		allboxes.forEach(item => item.checked = false);
	} else{
		allboxes.forEach(item => item.checked = true);
	}
	cal_checked_item_price();
}

function remove_checked_item() {
	const item_list = document.querySelectorAll("input[name=cart_item_id][type=checkbox]:checked");

	let arr = [];

	item_list.forEach(ele => arr.push(ele.value));

	remove_cart_submit(arr);
}


function cal_checked_item_price() {
	let cart_items = document.querySelectorAll("input[name=cart_item_id]:checked");

	let total = 0;
	let arr = [];
	
	cart_items.forEach((item) => {
		const tr = item.parentElement.parentElement.parentElement;
		let sub_total = String(tr.querySelector('#sub-total').innerHTML).replace(/[^0-9]/g, "");
		
		total += Number(sub_total);

		let objData = new Object();
 		objData.product_id = item.dataset.productId;
 		objData.variant_value_id = item.dataset.variantValueId;
 		objData.qty = item.dataset.qty;

 		arr.push(objData);
	});	

	document.querySelector("input[name=obj_data]").value=JSON.stringify(arr);
	document.querySelector("#total-price").innerHTML = '₱'+total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}


async function order_create_submit() {
	if(is_run == true) {
		openModal('알림','잠시후에 다시시도 해주세요.');
		return false;
	}

	is_run = true;

	let order_item_list = document.querySelector("input[name=obj_data]").value;

    const response = await fetch("{% url 'order:create' %}", {
		method: "POST",
		headers: {
			"X-CSRFToken": getCookie("csrftoken"),
		},
		body: JSON.stringify({
			'order_item_list': order_item_list
		}),
	})
	.then(response => response.json())
	.then(data => {
		console.log(data);
		is_run  = false;
		if (data.result == '200') {
			window.history.pushState("", "", `{% url 'order:view' %}?id=${data.result_text}`);
			window.location.reload();
		} else {
			openModal("알림", data.result_text);
		}
	});
}

</script>
{% endblock %}