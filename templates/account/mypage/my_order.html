{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load humanize %}

<!-- Section -->
<section class="position-relative">
	<div class="container position-relative">
		<!--Profile info header-->
		<div class="position-relative pt-9 pb-9 pb-lg-11">
			<div class="my_page_main row">
				{% include "account/mypage/sidemenu.html" with active_tab="주문 조회"%}	
				<div class="col-lg-9">
					{% include "account/mypage/topmenu.html" with active_tab="주문 조회"%}
					<div class="order_search_area">
						<div class="row">
							<div class="col-12">
								<!-- Page title -->
								<h4 class="my-4">주문 조회</h4>
								<!-- Table -->
								<div class="row main_contents">
									<div class="col-md-12">
										<div class="bg-secondary-soft p-3 p-md-5 rounded" style="padding: 0 !important;">
											<div class="table-responsive" style="text-align: center;">
												<table class="table row">
													<!-- Data -->
													<tbody>
														<tr>
															<td class="order-tb-left">기간별</td>
															<td class="col-6 order-tb-right">
																<button type="button" class="btn btn-outline-secondary order-tb-button">1주일</button>
																<button type="button" class="btn btn-outline-secondary order-tb-button">1개월</button>
																<button type="button" class="btn btn-outline-secondary order-tb-button">6개월</button>
																<button type="button" class="btn btn-outline-secondary order-tb-button">1년</button>
															</td>
															<td class="order-tb-left">카테고리별</td>
															<td class="col-6 order-tb-right">
																<select class="form-select" aria-label="Default select example">
																	<option selected>선택</option>
																	<option value="1">청소</option>
																	<option value="2">소독</option>
																	<option value="3">수리</option>
																	<option value="3">가전케어</option>
																	<option value="3">이사</option>
																	<option value="3">차 서비스</option>
																	<option value="3">생수 배달</option>
																</select>
															</td>
														</tr>
														<tr>
															<div class="row">
																<td class="order-tb-left">날짜</td>
																<td colspan="3" class="order-tb-right">
																	<div class="row">
																		<div class="col-md-10 input_group input-daterange">
																			<input class="form-control form-radius" type="date" id="start-date-input">
																			&nbsp;&nbsp;~&nbsp;&nbsp;
																			<input class="form-control form-radius" type="date" id="end-date-input">
																		</div>	
																		<div class="col-md-2 order-tb-search text-end">
																			<button type="submit" class="od-search-btn btn btn-lg btn-hover-text btn-secondary">
																				<span class="btn-hover-label label-default">Search</span>
																				<span class="btn-hover-label label-hover">Search</span>
																			</button>
																		</div>
																	</div>			
																</td>
															</div>
														</tr>
														<tr>
															<div class="row">
																<td class="col-1 order-tb-left">서비스명</td>
																<td class="col-5 order-tb-right">					
																	<div class="row">
																		<div class="col-md-9 mb-2 mb-md-0">
																			<input type="text" class="form-control form-radius " required
																				placeholder="주문하신 서비스명을 검색하세요.">
																		</div>
																		<div class="col-md-3 order-tb-search">
																			<button type="submit" class="od-search-btn btn btn-lg btn-hover-text btn-secondary">
																				<span class="btn-hover-label label-default">Search</span>
																				<span class="btn-hover-label label-hover">Search</span>
																			</button>
																		</div>
																	</div>
																</td>						
																<td class="col-1 order-tb-left">주문 상태</td>							
																<td class="col-5 order-tb-right">
																	<select class="form-select" aria-label="Default select example">
																		<option selected>선택</option>
																		<option value="1">입금대기</option>
																		<option value="2">결제완료</option>
																		<option value="3">서비스 대기</option>
																		<option value="3">서비스 완료</option>
																	</select>
																</td>
															</div>
														</tr>											
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div> 
						<!-- Oder list START -->
						<div class="row">
							<!-- Table -->
							<div class="row">
								<div class="col-md-12">
									<div class="bg-secondary-soft p-3 p-md-5 rounded" style="padding: 0 !important;">
										<div class="table-responsive" style="text-align: center;">
											<table class="table order_view">
												<!-- Title -->
												<thead>
													<tr>
														<th scope="col">주문일/주문번호</th>
														<th scope="col">서비스 정보</th>
														<th scope="col">수량</th>
														<th scope="col">주문금액</th>
														<th scope="col">진행상태</th>
													</tr>
												</thead>
												<!-- Data -->
												<tbody>
													{% for myOrder in my_order_list %}
													<tr>
														<td>{{myOrder.order.ordered_at}}</td>
														<td>{{myOrder.product_name}}</td>
														<td>{{myOrder.ordered_quantity}}</td>
														<td>₱{{myOrder.sub_total_price|intcomma}}</td>
														<td>
															완료
															<div class="mt-1">
																<button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#reviewWriteModal">Write Review</button>			
															</div>	
														</td>			
													</tr>
													{% endfor %}
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="row mb-5">
							<ul class="pagination justify-content-center m-0">
								{% if my_order_list.has_previous %}
								<li class="page-item ">
									<a class="page-link" href="?p={{my_order_list.previous_page_number }}{% if 'channel' in request.GET %}&channel={{request.GET.channel}}{% endif %}{% if 'type' in request.GET %}&type={{request.GET.type}}{% endif %}">이전</a>
								</li>
								{% else %}
								<li class="page-item disabled">
									<span class="page-link">이전</span>
								</li>
								{% endif %}
						
								{% for page_number in my_order_list.paginator.page_range %}
									{% if page_number >= my_order_list.number|add:-2 and page_number <= my_order_list.number|add:2 %}
										{% if page_number == my_order_list.number %}
										<li class="page-item active">
											<span class="page-link">{{ page_number }}</span>
										</li>
										{% else %}
										<li class="page-item">
												<a class="page-link" href="?p={{page_number }}{% if 'channel' in request.GET %}&channel={{request.GET.channel}}{% endif %}{% if 'type' in request.GET %}&type={{request.GET.type}}{% endif %}">{{ page_number }}</a>
										</li>
										{% endif %}
									{% endif %}
								{% endfor %}
						
								{% if my_order_list.has_next  %}
								<li class="page-item">
									<a class="page-link" href="?p={{my_order_list.next_page_number }}{% if 'channel' in request.GET %}&channel={{request.GET.channel}}{% endif %}{% if 'type' in request.GET %}&type={{request.GET.type}}{% endif %}">다음</a> 
								</li>
								{% else %}
								<li class="page-item disabled">
									<span class="page-link">다음</span>
								</li>
								{% endif %}
							</ul>
						</div>
						<!-- Order list END -->
					</div>	
				</div>
			</div>
		</div>
	</div>
</section>

<div class="modal fade" data-bs-backdrop="static" id="reviewWriteModal" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered modal-md">
		<div class="modal-content">
			<div class="review_content">
				<form name="reviewWriteForm">
					{% csrf_token %}
					<input type="hidden" name="order_id" value="">
					<div class="modal-body p-4 text-center">			
						<h5 class="review_title">만족하셨나요?</h5>
						<div class="rating">
							<input type="radio" name="rating" value="5" id="review-start-5"><label for="review-start-5">☆</label>
							<input type="radio" name="rating" value="4" id="review-start-4"><label for="review-start-4">☆</label>
							<input type="radio" name="rating" value="3" id="review-start-3"><label for="review-start-3">☆</label>
							<input type="radio" name="rating" value="2" id="review-start-2"><label for="review-start-2">☆</label>
							<input type="radio" name="rating" value="1" id="review-start-1"><label for="review-start-1">☆</label>
						</div>
					</div>
					<div class="upload_photo p-4">
						<h5 class="review_title">Upload images</h5>
						<!--Listing Images-->
						<div class="p-4 border rounded-3" data-dropzone-area="">
							<div class="dz-preview" id="dz-preview-row" data-horizontal-scroll="">
							</div>
							<div class="chat-form rounded-pill" data-emoji-form="">
								<button type="button"
								class="btn btn-outline-secondary dz-clickable"
								id="dz-btn">
								<i class="bx bx-cloud-upload fs-4 me-1"></i> Upload
							</button>
							</div>
						</div>

					</div>
					<div class="review_area p-4 text-center">
						<h5 class="review_title">리뷰를 작성해주세요.</h5>
						<textarea class="form-control" style="resize:none"></textarea>		
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-outline-primary ms-1" onclick="review_write_submit()">완료</button>
						<button type="button" class="btn btn-primary btn-md" id="reviewModalCloseBtn" data-bs-dismiss="modal">취소</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script src="{% static 'vendor/node_modules/js/dropzone-min.js' %}"></script>
<script>
function review_write_submit() {
      var reviewWriteForm = document.reviewWriteForm;
      var review = reviewWriteForm.review.value;
      var rating = reviewWriteForm.rating.value;
      let this_modal = "#ReviewWriteModal";
            
      if (isEmpty(rating)) {
         openPopup('알림','평점을 선택해주세요.',this_modal);
         return false;
      }

      if (isEmpty(review)) {
         openPopup('알림','리뷰를 입력해주세요.',this_modal);
         return false;
      }

      var queryString = $("form[name=reviewWriteForm]").serialize();

    $.ajax({
        type : 'POST',
        url : "",
        data : queryString,
        dataType : 'json',
        success: function(data){
          if(data.result==200){
            openPopup("알림", data.result_text,'',"reload");
          }else{
            openPopup("알림", data.result_text);
          }
          return;
        },
        error: function (request, status, error){
          var msg = "ERROR : " + request.status + "<br>"
             msg +=  + "내용 : " + request.responseText + "<br>" + error;
        }
    });
}


let e = new Dropzone("[data-dropzone-area]", {
	url: "#",
	clickable: "#dz-btn",
	acceptedFiles: '.jpeg,.jpg,.png,.gif,.JPEG,.JPG,.PNG,.GIF',
	previewsContainer: "#dz-preview-row",
	previewTemplate: '\n<div class="listing-img-preview position-relative">\n\n\n<div class="height-12x dropzone-image-preview position-relative">\n<img src="#" class="img-fluid rounded-3 file-title" data-dz-thumbnail="" alt="" >\n    </div>\n\n    <a class="badge p-0 bg-dark text-white bg-opacity-75 rounded-circle position-absolute top-0 end-0 m-1" href="#" data-dz-remove="">\n       <i class="bx bx-x fs-5 lh-1"></i>\n    </a>\n</div>\n',
	init: function () {
		// 최초 dropzone 설정시 init을 통해 호출
		let myDropzone = this; // closure 변수 (화살표 함수 쓰지않게 주의)

		// 서버에 제출 submit 버튼 이벤트 등록
		document.querySelector('#dz-btn').addEventListener('click', function () {

			// 거부된 파일이 있다면
			if (myDropzone.getRejectedFiles().length > 0) {
				let files = myDropzone.getRejectedFiles();
				console.log('거부된 파일이 있습니다.', files);
				return;
			}

			myDropzone.processQueue(); // autoProcessQueue: false로 해주었기 때문에, 메소드 api로 파일을 서버로 제출
		});

		this.on('addedfile', function (file) {
			// 중복된 파일의 제거
			if (this.files.length) {
				// -1 to exclude current file
				var hasFile = false;
				for (var i = 0; i < this.files.length - 1; i++) {
					if (
						this.files[i].name === file.name &&
						this.files[i].size === file.size &&
						this.files[i].lastModifiedDate.toString() === file.lastModifiedDate.toString()
					) {
						hasFile = true;
						this.removeFile(file);
					}
				}
			}


			for(var i=0; i< this.files.length; i++){
				var extension = this.files[i].name.split('.').pop().toLowerCase();		
				if(extension != 'jpg' && extension != 'jpeg' && extension != 'png' && extension != 'gif'){
					alert('이미지 파일이 아닙니다.');
					this.removeFile(file);
				}
			}
		});
   },
});
// 파일이 업로드되면 실행

/*오늘 날짜, 시간 셋팅*/
document.getElementById("start-date-input").value = new Date().toISOString().slice(0,10);
document.getElementById("end-date-input").value = new Date().toISOString().slice(0,10);

</script>
{% endblock %}