{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load humanize %}

<style>
.formFlex {
	display: flex;
	justify-content: space-between;
}
.inputBlock {
	display: inline-block; 
	width: 100%;
	margin-right: 10px;
}
.submitBlock {
	display: inline-block;
}
.resp-order-main {
	display: none;
}
.resp-order-main .title {
	padding: 10px 0;
	text-align: center;
	background-color: #f3f3f3;
}
.resp-order-main .title span {
	font-size: 18px;
}
.resp-order-main .contents {
	margin: 10px 0;
	text-align: center;
}
.resp-order-main .contents li {
	display: inline-block;
	margin-left: 10px;
}
.resp-order-main .contents li button[type=button] {
	padding: 10px 20px;
}
.status-main .contnets {
	margin: 10px 0;
}
.resp-od-list-main {
	display: none;
}
@media only screen and (max-width: 768px){
	.formFlex {
		flex-wrap: wrap;
	}
	.inputBlock {
		display: block;
		width: 100%;
	}
	.submitBlock {
		display: block;
		width: 100%;
	}
	.submitBlock button[type=submit] {
		margin-top: 10px;
		width: 100%;
	}

}
@media only screen and (max-width: 495px){
	.main_contents {
		display: none;
	}
	.resp-order-main {
		display: block;
	}
	.inputBlock {
		margin-right: 0;
	}

	.resp-od-list-main {
		display: block;
	}
}

</style>
<!-- Section -->
<section class="position-relative">
	<div class="container position-relative">
		<!--Profile info header-->
		<div class="position-relative pt-9 pb-9 pb-lg-11">
			<div class="row justify-content-center">
				{% include "account/mypage/sidemenu.html" with active_tab="주문 조회"%}	
				<div class="col-lg-9">
					{% include "account/mypage/topmenu.html" with active_tab="주문 조회"%}
					<div class="order_search_area">
						<div class="row">
							<div class="col-12">
								<!-- Page title -->
								<h4 class="my-4">주문 조회</h4>
								<!-- Table -->
								<div class="row main_contents">
									<div class="col-md-12">
										<div class="bg-secondary-soft p-3 p-md-5 rounded" style="padding: 0 !important;">
											<div class="table-responsive" style="text-align: center;">
												<table class="table">
													<!-- Data -->
													<tbody>
														<tr>
															<td class="order-tb-left">날짜</td>
															<td colspan="3">
																<div class="btn-group w-100 mb-3">
																	<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastWeekBtn();">1주일</button>
																	<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastOneMonthBtn();">1개월</button>
																	<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastThreeMonthBtn();">3개월</button>
																	<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastSixMonthBtn();">6개월</button>
																	<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastOneYearBtn();">1년</button>
																</div>		
																<form action="{{request.path}}" method="GET" name="dateSearchForm" class="mb-0 formFlex">
																	<div class="inputBlock">
																		<div class="input_group input-daterange">
																			<input class="form-control form-radius start-date-input" name="start_date" type="date">
																			&nbsp;&nbsp;~&nbsp;&nbsp;
																			<input class="form-control form-radius end-date-input" name="end_date" type="date">
																		</div>	
																	</div>
																	<div class="submitBlock">
																		<button type="submit" class="od-search-btn btn btn-lg btn-hover-text btn-secondary">
																			<span class="btn-hover-label label-default">Search</span>
																			<span class="btn-hover-label label-hover">Search</span>
																		</button>
																	</div>
																</form>
															</td>		
														</tr>
														<tr>
															<td class="order-tb-left">카테고리</td>
															<td class="order-tb-right">
																<select class="form-select" name="category_by" aria-label="Default select example">
																	<option value="" {% if not request.GET.category %}selected{% endif %}>선택</option>
																	{% for category_obj in category_objs %}
																	<option value="{{category_obj.pk}}" {% if request.GET.category|slugify == category_obj.pk|slugify %}selected{% endif %}>{{category_obj.name}}</option>
																	{% endfor %}
																</select>
															</td>
															
																<td class="order-tb-left">진행 상태</td>							
																<td class="order-tb-right">
																	<select class="form-select" name="status_by" aria-label="Default select example">
																		<option value="">선택</option>
																		{% for k, v in order_status_dict %}
																		<option value="{{k}}">{{v}}</option>
																		{% endfor %}
																	</select>
																</td>
															
														</tr>
														<tr>
															<td class="order-tb-left">서비스명</td>
															<td colspan="3" class="order-tb-right">						
																<form action="{{request.path}}" method="GET" name="keywordSearchForm" class="mb-0 formFlex">
																	<div class="inputBlock">
																		<input type="text" class="form-control form-radius" name="keyword"
																			placeholder="서비스명을 검색하세요.">
																	</div>
																	<div class="submitBlock">
																		<button type="submit"class="od-search-btn btn btn-lg btn-hover-text btn-secondary">
																			<span class="btn-hover-label label-default">Search</span>
																			<span class="btn-hover-label label-hover">Search</span>
																		</button>
																	</div>
																</form>
															</td>																			
														</tr>							
																	
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>

								<!-- Responsive  Order Search -->
								<div class="row resp-order-main">
									<div class="col-md-12">
										<div class="bg-secondary-soft p-3 p-md-5 rounded" style="padding: 0 !important;">	
											<div class="datesearch-main">
												<div class="title">
													<span>날짜</span>
												</div>		
												<div class="contents">
													<div class="btn-group mb-3">
														<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastWeekBtn();">1주일</button>
														<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastOneMonthBtn();">1개월</button>
														<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastThreeMonthBtn();">3개월</button>
														<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastSixMonthBtn();">6개월</button>
														<button type="button" class="btn btn-outline-secondary order-tb-button" onclick="lastOneYearBtn();">1년</button>
													</div>
													<div class="datasearch-body">
														<form action="{{request.path}}" method="GET" name="dateSearchForm" class="mb-0 formFlex">
															<div class="inputBlock">
																<div class="input_group input-daterange">
																	<input class="form-control form-radius start-date-input" name="start_date" type="date">
																	&nbsp;&nbsp;~&nbsp;&nbsp;
																	<input class="form-control form-radius end-date-input" name="end_date" type="date">
																</div>	
															</div>
															<div class="submitBlock">
																<button type="submit" class="od-search-btn btn btn-lg btn-hover-text btn-secondary">
																	<span class="btn-hover-label label-default">Search</span>
																	<span class="btn-hover-label label-hover">Search</span>
																</button>
															</div>
														</form>
													</div>
												</div>										
											</div>
											<div class="category-main">
												<div class="title">
													<span>카테고리</span>
												</div>		
												<div class="contents">
													<select class="form-select" name="category_by" aria-label="Default select example">
														<option value="" {% if not request.GET.category %}selected{% endif %}>선택</option>
														{% for category_obj in category_objs %}
														<option value="{{category_obj.pk}}" {% if request.GET.category|slugify == category_obj.pk|slugify %}selected{% endif %}>{{category_obj.name}}</option>
														{% endfor %}
													</select>
												</div>										
											</div>
											<div class="status-main">
												<div class="title">
													<span>진행 상태</span>
												</div>	
												<div class="contnets">
													<select class="form-select" name="status_by" aria-label="Default select example">
														<option value="">선택</option>
														{% for k, v in order_status_dict %}
														<option value="{{k}}">{{v}}</option>
														{% endfor %}
													</select>
												</div>											
											</div>
											<div class="kewordsearch-main">
												<div class="title">
													<span>서비스명</span>
												</div>	
												<div class="contents">
													<form action="{{request.path}}" method="GET" name="keywordSearchForm" class="mb-0 formFlex">
														<div class="inputBlock">
															<input type="text" class="form-control form-radius" name="keyword"
																placeholder="서비스명을 검색하세요.">
														</div>
														<div class="submitBlock">
															<button type="submit"class="od-search-btn btn btn-lg btn-hover-text btn-secondary">
																<span class="btn-hover-label label-default">Search</span>
																<span class="btn-hover-label label-hover">Search</span>
															</button>
														</div>
													</form>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div> 

						<!-- Order list -->
						<div class="row main_contents">
							<div class="col-md-12 mt-5">
								<div class="bg-secondary-soft p-3 p-md-5 rounded" style="padding: 0 !important;">
									<div class="table-responsive" style="text-align: center;">
										<table class="table order_view">
											<!-- Title -->
											<h4 class="text-start mb-3">주문 목록</h4>
											<thead>
												<tr>
													<th scope="col">주문일/주문번호</th>
													<th scope="col">서비스 정보</th>
													<th scope="col">수량</th>
													<th scope="col">주문 금액</th>
													<th scope="col">진행 상태</th>
												</tr>
											</thead>
											<!-- Data -->
											<tbody>
												{% for my_order_obj in my_order_objs %}
												<tr>
													<td>{{my_order_obj.order.ordered_at}}</td>
													<td>{{my_order_obj.product_name}}</td>
													<td>{{my_order_obj.ordered_quantity}}</td>
													<td>₱{{my_order_obj.sub_total_price|intcomma}}</td>
													<td>
														완료
														<div class="mt-1">
															<button type="button" class="btn btn-outline-secondary btn-rise" data-bs-toggle="modal" data-bs-target="#reviewWriteModal">
																<div class="btn-rise-bg bg-secondary"></div>
																<div class="btn-rise-text">
																	Write Review
																</div>
															</button>			
														</div>	
													</td>			
												</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>

						<!-- Responsive Order list -->
						<div class="row resp-od-list-main">
							<div class="col-md-12">
									<div class="order_info row">
										<div class="col-12 align-middle text-center py-4">
											<div class="row">
												<div class="col-xxl-6">
													<div class="row border-0">
														<h4 class="text-start mb-3">주문 목록</h4>
														<!-- Image -->
														{% for my_order_obj in my_order_objs %}
														<div class="col-xl-3 text-center">
															<img class="rounded w-100" src="{% static 'img/mypage/subs01.jpg' %}" alt="Listing image1">
														</div>
														<!-- Info -->
														<div class="col-xl-9 pt-2 pt-xl-0 text-center">
															<h6 class="mb-1 fs-1">{{my_order_obj.product_name}}</h6>
															<p class="mb-1 fs-4 text-success">₱{{my_order_obj.sub_total_price|intcomma}} / {{my_order_obj.ordered_quantity}}</p>
															<span class="fs-4 text-secondary">{{my_order_obj.order.ordered_at}}</span>
														</div>
														<div class="list-status-main mb-5">
															<span class="fs-4">진행 상태</span>
															<div class="contnets">
																<span class="text-danger fs-5">완료</span>
																<div class="mt-1">
																	<button type="button" class="btn btn-sm btn-primary w-100 fs-5" data-bs-toggle="modal" data-bs-target="#reviewWriteModal">Write Review</button>			
																</div>	
															</div>
														</div>
														<hr>
														{% endfor %}
													</div>
												</div>
											</div> 
										</div>
									</div>
								</div>
							</div>
						</div>
						
						<div class="row mb-5">
							<ul class="pagination justify-content-center m-0">
								{% if my_order_objs.has_previous %}
								<li class="page-item ">
									<a class="page-link" href="?p={{my_order_objs.previous_page_number }}{% if 'channel' in request.GET %}&channel={{request.GET.channel}}{% endif %}{% if 'type' in request.GET %}&type={{request.GET.type}}{% endif %}">이전</a>
								</li>
								{% else %}
								<li class="page-item disabled">
									<span class="page-link">이전</span>
								</li>
								{% endif %}
						
								{% for page_number in my_order_objs.paginator.page_range %}
									{% if page_number >= my_order_objs.number|add:-2 and page_number <= my_order_objs.number|add:2 %}
										{% if page_number == my_order_objs.number %}
										<li class="page-item active">
											<span class="page-link">{{ page_number }}</span>
										</li>
										{% else %}
										<li class="page-item">
												<a class="page-link" href="?p={{page_number }}{% if 'channel' in request.GET %}&channel={{request.GET.channel}}{% endif %}{% if 'type' in request.GET %}&type={{request.GET.type}}{% endif %}">{{ page_number }}</a>
										</li>
										{% endif %}
									{% endif %}
								{% endfor %}
						
								{% if my_order_objs.has_next  %}
								<li class="page-item">
									<a class="page-link" href="?p={{my_order_objs.next_page_number }}{% if 'channel' in request.GET %}&channel={{request.GET.channel}}{% endif %}{% if 'type' in request.GET %}&type={{request.GET.type}}{% endif %}">다음</a> 
								</li>
								{% else %}
								<li class="page-item disabled">
									<span class="page-link">다음</span>
								</li>
								{% endif %}
							</ul>
						</div>
						<!-- Order list END -->
					</div>	
				</div>
			</div>
		</div>
	</div>
</section>

<div class="modal fade" data-bs-backdrop="static" id="reviewWriteModal" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered modal-md">
		<div class="modal-content">
			<div class="review_content">
				<form name="reviewWriteForm">
					{% csrf_token %}
					<input type="hidden" name="order_id" value="">
					<div class="modal-body p-4 text-center">			
						<h5 class="review_title">만족하셨나요?</h5>
						<div class="rating">
							<input type="radio" name="rating" value="5" id="review-start-5"><label for="review-start-5">☆</label>
							<input type="radio" name="rating" value="4" id="review-start-4"><label for="review-start-4">☆</label>
							<input type="radio" name="rating" value="3" id="review-start-3"><label for="review-start-3">☆</label>
							<input type="radio" name="rating" value="2" id="review-start-2"><label for="review-start-2">☆</label>
							<input type="radio" name="rating" value="1" id="review-start-1"><label for="review-start-1">☆</label>
						</div>
					</div>
					<div class="upload_photo p-4">
						<h5 class="review_title">Upload images</h5>
						<!--Listing Images-->
						<div class="p-4 border rounded-3" data-dropzone-area="">
							<div class="dz-preview" id="dz-preview-row" data-horizontal-scroll="">
							</div>
							<div class="chat-form rounded-pill" data-emoji-form="">
								<button type="button"
								class="btn btn-outline-secondary dz-clickable"
								id="dz-btn">
								<i class="bx bx-cloud-upload fs-4 me-1"></i> Upload
							</button>
							</div>
						</div>

					</div>
					<div class="review_area p-4 text-center">
						<h5 class="review_title">리뷰를 작성해주세요.</h5>
						<textarea class="form-control" style="resize:none"></textarea>		
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-outline-primary ms-1" onclick="review_write_submit()">완료</button>
						<button type="button" class="btn btn-primary btn-md" id="reviewModalCloseBtn" data-bs-dismiss="modal">취소</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script src="{% static 'vendor/node_modules/js/dropzone-min.js' %}"></script>
<script>
function review_write_submit() {
      var reviewWriteForm = document.reviewWriteForm;
      var review = reviewWriteForm.review.value;
      var rating = reviewWriteForm.rating.value;
      let this_modal = "#ReviewWriteModal";
            
      if (isEmpty(rating)) {
         openPopup('알림','평점을 선택해주세요.',this_modal);
         return false;
      }

      if (isEmpty(review)) {
         openPopup('알림','리뷰를 입력해주세요.',this_modal);
         return false;
      }

      var queryString = $("form[name=reviewWriteForm]").serialize();

    $.ajax({
        type : 'POST',
        url : "",
        data : queryString,
        dataType : 'json',
        success: function(data){
          if(data.result==200){
            openPopup("알림", data.result_text,'',"reload");
          }else{
            openPopup("알림", data.result_text);
          }
          return;
        },
        error: function (request, status, error){
          var msg = "ERROR : " + request.status + "<br>"
             msg +=  + "내용 : " + request.responseText + "<br>" + error;
        }
    });
}


let e = new Dropzone("[data-dropzone-area]", {
	url: "#",
	clickable: "#dz-btn",
	acceptedFiles: '.jpeg,.jpg,.png,.gif,.JPEG,.JPG,.PNG,.GIF',
	previewsContainer: "#dz-preview-row",
	previewTemplate: '\n<div class="listing-img-preview position-relative">\n\n\n<div class="height-12x dropzone-image-preview position-relative">\n<img src="#" class="img-fluid rounded-3 file-title" data-dz-thumbnail="" alt="" >\n    </div>\n\n    <a class="badge p-0 bg-dark text-white bg-opacity-75 rounded-circle position-absolute top-0 end-0 m-1" href="#" data-dz-remove="">\n       <i class="bx bx-x fs-5 lh-1"></i>\n    </a>\n</div>\n',
	init: function () {
		// 최초 dropzone 설정시 init을 통해 호출
		let myDropzone = this; // closure 변수 (화살표 함수 쓰지않게 주의)

		// 서버에 제출 submit 버튼 이벤트 등록
		document.querySelector('#dz-btn').addEventListener('click', function () {

			// 거부된 파일이 있다면
			if (myDropzone.getRejectedFiles().length > 0) {
				let files = myDropzone.getRejectedFiles();
				console.log('거부된 파일이 있습니다.', files);
				return;
			}

			myDropzone.processQueue(); // autoProcessQueue: false로 해주었기 때문에, 메소드 api로 파일을 서버로 제출
		});

		this.on('addedfile', function (file) {
			// 중복된 파일의 제거
			if (this.files.length) {
				// -1 to exclude current file
				var hasFile = false;
				for (var i = 0; i < this.files.length - 1; i++) {
					if (
						this.files[i].name === file.name &&
						this.files[i].size === file.size &&
						this.files[i].lastModifiedDate.toString() === file.lastModifiedDate.toString()
					) {
						hasFile = true;
						this.removeFile(file);
					}
				}
			}


			for(var i=0; i< this.files.length; i++){
				var extension = this.files[i].name.split('.').pop().toLowerCase();		
				if(extension != 'jpg' && extension != 'jpeg' && extension != 'png' && extension != 'gif'){
					alert('이미지 파일이 아닙니다.');
					this.removeFile(file);
				}
			}
		});
   },
});


const category_by = document.querySelector('select[name=category_by]');

category_by.addEventListener('change', (event) => {
	var link = `{{request.path}}?category=${event.target.value}`;
	location.href=link;
});

const status_by = document.querySelector('select[name=status_by]');

status_by.addEventListener('change', (event) => {
	var link = `{{request.path}}?status=${event.target.value}`;
	location.href=link;
});


document.getElementsByClassName("start-date-input")[0].value = new Date().toISOString().slice(0,10);
document.getElementsByClassName("end-date-input")[0].value = new Date().toISOString().slice(0,10);

function lastWeekBtn(){
	let nowDate = new Date();
	let weekDate = nowDate.getTime() - (7*24*60*60*1000);
	nowDate.setTime(weekDate);

	let weekYear = nowDate.getFullYear();
	let weekMonth = nowDate.getMonth() + 1;
	let weekDay = nowDate.getDate();

	if(weekMonth < 10) {weekMonth = "0" + weekMonth};
	if(weekDay < 10) {weekDay = "0" + weekDay};

	let resultDate = weekYear + "-" + weekMonth + "-" + weekDay;

  document.getElementsByClassName("start-date-input")[0].value = resultDate;
}  

function lastOneMonthBtn(){
	let nowDate = new Date();
	let monthDate = nowDate.getTime() - (30*24*60*60*1000);
	nowDate.setTime(monthDate);

	let weekYear = nowDate.getFullYear();
	let weekMonth = nowDate.getMonth() + 1;
	let weekDay = nowDate.getDate() - 1;

	if(weekMonth < 10) {weekMonth = "0" + weekMonth};
	if(weekDay < 10) {weekDay = "0" + weekDay};

	let resultDate = weekYear + "-" + weekMonth + "-" + weekDay;

  document.getElementsByClassName("start-date-input")[0].value = resultDate;	
}
function lastThreeMonthBtn(){
	let nowDate = new Date();
	let threeMonthDate = nowDate.getTime() - (3*30*24*60*60*1000);
	nowDate.setTime(threeMonthDate);

	let weekYear = nowDate.getFullYear();
	let weekMonth = nowDate.getMonth() + 1;
	let weekDay = nowDate.getDate() - 2;

	if(weekMonth < 10) {weekMonth = "0" + weekMonth};
	if(weekDay < 10) {weekDay = "0" + weekDay};

	let resultDate = weekYear + "-" + weekMonth + "-" + weekDay;

  document.getElementsByClassName("start-date-input")[0].value = resultDate;	
}
function lastSixMonthBtn(){
	let nowDate = new Date();
	let sixMonthDte = nowDate.getTime() - (6*30*24*60*60*1000);
	nowDate.setTime(sixMonthDte);

	let weekYear = nowDate.getFullYear();
	let weekMonth = nowDate.getMonth() + 1;
	let weekDay = nowDate.getDate() -4;

	if(weekMonth < 10) {weekMonth = "0" + weekMonth};
	if(weekDay < 10) {weekDay = "0" + weekDay};

	let resultDate = weekYear + "-" + weekMonth + "-" + weekDay;

  document.getElementsByClassName("start-date-input")[0].value = resultDate;	
}
function lastOneYearBtn(){
	let nowDate = new Date();
	let sixMonthDte = nowDate.getTime() - (12*30*24*60*60*1000);
	nowDate.setTime(sixMonthDte);

	let weekYear = nowDate.getFullYear();
	let weekMonth = nowDate.getMonth() + 1;
	let weekDay = nowDate.getDate() -5;

	if(weekMonth < 10) {weekMonth = "0" + weekMonth};
	if(weekDay < 10) {weekDay = "0" + weekDay};

	let resultDate = weekYear + "-" + weekMonth + "-" + weekDay;

  document.getElementsByClassName("start-date-input")[0].value = resultDate;	
}
</script>
{% endblock %}